name: Auto Update WCG Stats & Deploy

on:
  schedule:
    - cron: '0 */6 * * *' # ë§¤ 6ì‹œê°„ë§ˆë‹¤ ìë™ ì‹¤í–‰ (UTC ê¸°ì¤€)
  workflow_dispatch:      # ê¹ƒí—ˆë¸Œ ì›¹ì—ì„œ ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼ (í…ŒìŠ¤íŠ¸ìš©)

permissions:
  contents: write         # ì €ì¥ì†Œ ì½ê¸°/ì“°ê¸°/ë°°í¬ ê¶Œí•œ ë¶€ì—¬

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Source Code
        uses: actions/checkout@v4

      # 2. íŒŒì´ì¬ í™˜ê²½ ì„¤ì •
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      # 3. íŒŒì´ì¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
      - name: Install Python dependencies
        run: |
          pip install beautifulsoup4 requests

      # 4. í¬ë¡¤ë§ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (ë°ì´í„° ê°±ì‹ )
      - name: Run Scraping Script
        run: |
          # scripts í´ë” ì•ˆì˜ íŒŒì´ì¬ íŒŒì¼ ì‹¤í–‰
          python scripts/fetch_real_data_bs4.py

      # 5. [ì—ëŸ¬ í•´ê²° êµ¬ê°„] ë³€ê²½ëœ ë°ì´í„°ë¥¼ main ë¸Œëœì¹˜ì— ì €ì¥ (ì¶©ëŒ ë°©ì§€ ë¡œì§ í¬í•¨)
      - name: Commit and Push changes to Main
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # ë³€ê²½ëœ íŒŒì¼ ì¶”ê°€
          git add .
          
          # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
          if ! git diff --quiet && ! git diff --staged --quiet; then
            echo "Changes detected. Committing..."
            git commit -m "ğŸ¤– Auto-update WCG stats data"
            
            # ğŸš¨ [í•µì‹¬] ì—ëŸ¬ê°€ ë‚¬ë˜ ë¶€ë¶„ í•´ê²°ì±…
            # ì„œë²„ì— ìˆëŠ” ìµœì‹  ì½”ë“œë¥¼ ë¨¼ì € ë‚´ ìª½ìœ¼ë¡œ ë‹¹ê²¨ì™€ì„œ(Pull) í•©ì¹¨(Rebase)
            git pull --rebase origin main
            
            # ê·¸ ë‹¤ìŒ ë°€ì–´ë„£ê¸° (ì´ì œ ì—ëŸ¬ ì•ˆ ë‚¨)
            git push origin main
          else
            echo "No changes to commit."
          fi

      # 6. Node.js í™˜ê²½ ì„¤ì •
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 7. íŒ¨í‚¤ì§€ ì„¤ì¹˜ ë° ë¦¬ì•¡íŠ¸ ë¹Œë“œ
      - name: Install & Build
        run: |
          npm install       # ì˜ì¡´ì„± ì„¤ì¹˜
          npm run build     # ë¹Œë“œ ì‹¤í–‰ (dist í´ë” ìƒì„±)

      # 8. gh-pages ë¸Œëœì¹˜ë¡œ ë°°í¬ (ì›¹ì‚¬ì´íŠ¸ ì—…ë°ì´íŠ¸)
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist # Vite ë¹Œë“œ ê²°ê³¼ë¬¼ í´ë”
          force_orphan: true  # ê¹”ë”í•˜ê²Œ ë®ì–´ì“°ê¸°
